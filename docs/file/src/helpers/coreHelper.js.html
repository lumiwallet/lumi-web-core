<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/helpers/coreHelper.js | lumi-web-core</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Lumi Wallet Core - Web Version"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="lumi-web-core"><meta property="twitter:description" content="Lumi Wallet Core - Web Version"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/lumiwallet/lumi-web-core"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Wrapper.js~Wrapper.html">Wrapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/index.js~Wallet.html">Wallet</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#class">class</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/Core.js~Core.html">Core</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/WalletWrapper.js~WalletWrapper.html">WalletWrapper</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#class-btc">class/BTC</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/BTC/BitcoinSync.js~BitcoinSync.html">BitcoinSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/BTC/BitcoinTx.js~BitcoinTx.html">BitcoinTx</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#class-eth">class/ETH</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/ETH/EthereumSync.js~EthereumSync.html">EthereumSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/ETH/EthereumTx.js~EthereumTx.html">EthereumTx</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#helpers">helpers</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/helpers/handleErrors.js~CustomError.html">CustomError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-calcBtcTxSize">calcBtcTxSize</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-derive">derive</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generateMnemonic">generateMnemonic</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getBtcAddress">getBtcAddress</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getEthAddress">getEthAddress</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getEthAddressByNode">getEthAddressByNode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getEthPrivateKey">getEthPrivateKey</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getEthPublicKey">getEthPublicKey</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getXprv">getXprv</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hdFromSeed">hdFromSeed</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hdFromXprv">hdFromXprv</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-makeRawBtcTx">makeRawBtcTx</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-makeRawEthTx">makeRawEthTx</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mnemonicToEntropy">mnemonicToEntropy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mnemonicToSeed">mnemonicToSeed</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-privateKeyToWIF">privateKeyToWIF</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-requestHandleErrors">requestHandleErrors</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-toFormatDecimal">toFormatDecimal</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/helpers/coreHelper.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import * as bip39 from &apos;bip39&apos;
import * as bitcoin from &apos;bitcoinjs-lib&apos;
import {Transaction} from &apos;ethereumjs-tx&apos;
import * as ethUtil from &apos;ethereumjs-util&apos;
import * as HDkey from &apos;hdkey&apos;
import * as utils from &apos;web3-utils&apos;
import wif from &apos;wif&apos;
import CustomError from &apos;@/helpers/handleErrors&apos;

/**
 * Generation of mnemonics.
 * The number of words in a mnemonic depends on the length of the entropy
 * @param {number} entropyLength - The number of bits in the entropy. It can be equal to 128, 160, 192, 224 or 256 bits
 * @returns {string} - A mnemonic whose words are separated by spaces
 */
export function generateMnemonic (entropyLength = 128) {
  try {
    return bip39.generateMnemonic(entropyLength)
  }
  catch (e) {
    console.log(e)
    throw new CustomError(&apos;err_core_entropy&apos;)
  }
}

/**
 * Converting a mnemonic to seed
 * @param {string} mnemonic - Mnemonic phrase
 * @returns {Buffer} - Seed in Uint8Array format
 */
export function mnemonicToSeed (mnemonic) {
  try {
    return bip39.mnemonicToSeedSync(mnemonic)
  }
  catch (e) {
    console.log(e)
    throw new CustomError(&apos;err_core_mnemonic&apos;)
  }
}

/**
 * Converting a mnemonic to entropy
 * @param {string} mnemonic - Mnemonic phrase
 * @returns {string} HEX strings entropy
 */
export function mnemonicToEntropy (mnemonic) {
  try {
    return bip39.mnemonicToEntropy(mnemonic)
  }
  catch (e) {
    console.log(e)
    throw new CustomError(&apos;err_core_mnemonic&apos;)
  }
}

/**
 * Converting a seed to hdkey (Hierarchical Deterministic Key)
 * @param {Buffer} seed - Mnemonic seed in Buffer
 * @returns {Object} hdkey object with private and public key
 */
export function hdFromSeed (seed) {
  try {
    return HDkey.fromMasterSeed(seed)
  }
  catch (e) {
    console.log(e)
    throw new CustomError(&apos;err_core_seed&apos;)
  }
}


/**
 * Converting a xprv to hdkey (Hierarchical Deterministic Key)
 * @param {string} xprv - Extended private key
 * @returns {Object} hdkey object with private and public key
 */
export function hdFromXprv (xprv) {
  try {
    return HDkey.fromExtendedKey(xprv)
  }
  catch (e) {
    console.log(e)
    throw new CustomError(&apos;err_core_xprv&apos;)
  }
}

/**
 * Getting xprv by hdkey
 * @param {Object} hd - HDkey node
 * @returns {string} Extended private key
 */
export function getXprv (hd) {
  try {
    return hd.privateExtendedKey
  }
  catch (e) {
    console.log(e)
    throw new CustomError(&apos;err_core_hdkey&apos;)
  }
}

/**
 * Derivation of node. Getting child node by path
 * @param {Object} hd - HDkey node
 * @param {string} path - Derivation path
 * @returns {Object} - Child node
 */

export function derive (hd, path) {
  if (!hd) {
    throw new CustomError(&apos;err_core_derivation_hdkey&apos;)
  }
  
  if (!path) {
    throw new CustomError(&apos;err_core_derivation_path&apos;)
  }
  
  let regex = new RegExp(/(^\m\/44\&apos;)([\/{1}\d+\&apos;{1}]+)/mg)
  
  if (!regex.test(path)) {
    throw new CustomError(&apos;err_core_derivation_path&apos;)
  }
  
  try {
    return hd.derive(path)
  }
  catch (e) {
    console.log(e)
    throw new CustomError(&apos;err_core_derivation&apos;)
  }
}

/**
 * Getting a bitcoin address by node and child index
 * @param {Object} node - HDkey node
 * @param {number} childIndex - Index of the child node
 * @returns {string} Bitcoin address
 */

export function getBtcAddress (node, childIndex = 0) {
  try {
    let pubKey = node.deriveChild(childIndex).publicKey
    
    return bitcoin.payments.p2pkh({
      pubkey: pubKey
    }).address
  }
  catch (e) {
    console.log(e)
    throw new CustomError(&apos;err_core_btc_address&apos;)
  }
}

/**
 * Getting a Ethereum private key by node
 * @param {Object} node - Ethereum node
 * @returns {Buffer} Ethereum private key in Uint8Array format
 */

export function getEthPrivateKey (node) {
  try {
    return node._privateKey
  }
  catch (e) {
    console.log(e)
    throw new CustomError(&apos;err_core_eth_node&apos;)
  }
}

/**
 * Getting a Ethereum public key by private key
 * @param {Buffer} privateKey - Ethereum private key
 * @returns {Buffer} Ethereum public key in Uint8Array format
 */

export function getEthPublicKey (privateKey) {
  try {
    return ethUtil.privateToPublic(privateKey)
  }
  catch (e) {
    console.log(e)
    throw new CustomError(&apos;err_core_eth_private_key&apos;)
  }
}

/**
 * Getting a Ethereum wallet address by public key
 * @param {Buffer} publicKey - Ethereum public key
 * @returns {string} Ethereum wallet address
 */

export function getEthAddress (publicKey) {
  try {
    let addrBuffer = ethUtil
      .publicToAddress(publicKey)
      .toString(&apos;hex&apos;)
    return ethUtil.toChecksumAddress(addrBuffer).toLowerCase()
  }
  catch (e) {
    console.log(e)
    throw new CustomError(&apos;err_core_eth_public_key&apos;)
  }
}

/**
 * Getting Ethereum wallet address by node
 * @param {Object} node - Ethereum node
 * @returns {string} Ethereum wallet address
 */

export function getEthAddressByNode (node) {
  try {
    let privateKey = getEthPrivateKey(node)
    let publicKey = getEthPublicKey(privateKey)
    return getEthAddress(publicKey)
  }
  catch (e) {
    console.log(e)
    throw new CustomError(&apos;err_core_eth_public_key&apos;)
  }
}

/**
 * Convert a Bitcoin private key to the WIF (Wallet Import Format)
 * @param {Buffer} privateKey - Private key in Uint8Array format
 * @returns {string} Private key in WIF
 */
export function privateKeyToWIF (privateKey) {
  try {
    return wif.encode(128, privateKey, true)
  }
  catch (e) {
    throw new CustomError(&apos;err_core_private_key&apos;)
  }
}

/**
 * Calculating the transaction size by the number of inputs and outputs
 * @param {number} i - Number of inputs. By default 1
 * @param {number} o - Number of outputs. By default 2
 * @returns {number} Transaction size
 */

export function calcBtcTxSize (i = 1, o = 2) {
  return i * 148 + o * 34 + 10
}

/**
 * Creating a raw Bitcoin transaction
 * @param {Object} data - Input data for a transaction
 * @param {Array} data.inputs - List of inputs
 * @param {Array} data.outputs - List of outputs
 * @returns {Object} Returns raw transaction and transaction hash
 */

export function makeRawBtcTx (data = {}) {
  try {
    const {inputs, outputs} = data
    let txb = new bitcoin.TransactionBuilder()
    
    txb.setVersion(1)
    
    inputs.forEach((item) =&gt; {
      txb.addInput(item.hash, +item.n)
    })
    
    outputs.forEach((item) =&gt; {
      txb.addOutput(item.address, +item.value)
    })
    
    inputs.forEach((item, index) =&gt; {
      let key = bitcoin.ECPair.fromWIF(item.key)
      txb.sign(index, key)
    })
    
    let tx = txb.build()
    let hash = tx.getId()
    
    return {
      hash,
      tx: tx.toHex()
    }
  }
  catch (e) {
    console.log(e)
    throw new CustomError(&apos;err_tx_btc_build&apos;)
  }
}

/**
 * Creating a raw Ethereum transaction
 * @param {Object} data - Input data for a transaction
 * @param {string} data.to - Recipient address or contract address
 * @param {number} data.value - Transaction amount
 * @param {number} data.nonce - Nonce, transaction count of an account
 * @param {number} data.gasPrice - Transaction gas price
 * @param {number} data.gasLimit - Transaction gas limit
 * @param {string} data.from - Ethereum sender address (required for ERC20 transactions)
 * @param {string} data.data - Data in hex representation (required for ERC20 transactions)
 * @param {string|Buffer} data.privateKey - Ethereum private key in hex or Buffer format
 * @returns {Object} Returns raw transaction and transaction hash
 */

export function makeRawEthTx (data = {}) {
  const {to, value, nonce, gasPrice, gasLimit, privateKey, chainId} = data
  
  if (isNaN(nonce) || isNaN(value) || isNaN(gasPrice) ||
    isNaN(gasLimit)) {
    throw new CustomError(&apos;err_tx_eth_invalid_params&apos;)
  }
  
  if (typeof to !== &apos;string&apos;) {
    throw new CustomError(&apos;err_tx_eth_invalid_params_string&apos;)
  }
  
  try {
    let params = {
      to: to,
      nonce: utils.toHex(parseInt(nonce)),
      value: utils.toHex(parseInt(value)),
      gasPrice: utils.toHex(parseInt(gasPrice)),
      gasLimit: utils.toHex(parseInt(gasLimit)),
      chainId: utils.toHex(1)
    }
    
    if (data.hasOwnProperty(&apos;from&apos;) &amp;&amp; data.from) {
      params.from = data.from
    }
    
    if (data.hasOwnProperty(&apos;data&apos;) &amp;&amp; data.data) {
      params.data = data.data
    }
    
    const tx = new Transaction(params)
    const privateKeyBuffer = ethUtil.toBuffer(privateKey)
    
    tx.sign(privateKeyBuffer)
    
    const serializedTx = tx.serialize()
    const hash = tx.hash().toString(&apos;hex&apos;)
    
    return {
      hash: `0x${ hash }`,
      tx: `0x${ serializedTx.toString(&apos;hex&apos;) }`
    }
  }
  catch (e) {
    console.log(e)
    throw new CustomError(&apos;err_tx_eth_build&apos;)
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
