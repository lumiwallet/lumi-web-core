<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">src/class/DOGE/DogecoinSync.js | lumi-web-core</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Lumi Wallet Core - Web Version"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="lumi-web-core"><meta property="twitter:description" content="Lumi Wallet Core - Web Version"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/lumiwallet/lumi-web-core"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Wrapper.js~Wrapper.html">Wrapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/index.js~Wallet.html">Wallet</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#class">class</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/Core.js~Core.html">Core</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/WalletWrapper.js~WalletWrapper.html">WalletWrapper</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#class-bch">class/BCH</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/BCH/BitcoinCashSync.js~BitcoinCashSync.html">BitcoinCashSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/BCH/BitcoinCashTx.js~BitcoinCashTx.html">BitcoinCashTx</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#class-bnb">class/BNB</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/BNB/transaction.js~BinanceTx.html">BinanceTx</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-decodeAddress">decodeAddress</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-encodeAddress">encodeAddress</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getBnbAddressByPublicKey">getBnbAddressByPublicKey</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-convertObjectToSignBytes">convertObjectToSignBytes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-encodeArrayBinary">encodeArrayBinary</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-encodeBinary">encodeBinary</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-encodeBinaryByteArray">encodeBinaryByteArray</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-encodeBool">encodeBool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-encodeNumber">encodeNumber</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-encodeObjectBinary">encodeObjectBinary</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-encodeString">encodeString</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-marshalBinary">marshalBinary</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getBnbCore">getBnbCore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-convertToBinance">convertToBinance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-convertToJager">convertToJager</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generateSignature">generateSignature</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AminoPrefix">AminoPrefix</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#class-btc">class/BTC</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/BTC/BitcoinSync.js~BitcoinSync.html">BitcoinSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/BTC/BitcoinTx.js~BitcoinTx.html">BitcoinTx</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#class-btcv">class/BTCV</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/BTCV/BitcoinVaultSync.js~BitcoinVaultSync.html">BitcoinVaultSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/BTCV/BitcoinVaultTx.js~BitcoinVaultTx.html">BitcoinVaultTx</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#class-doge">class/DOGE</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/DOGE/DogecoinSync.js~DogecoinSync.html">DogecoinSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/DOGE/DogecoinTx.js~DogecoinTx.html">DogecoinTx</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#class-eth">class/ETH</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/ETH/EthereumSync.js~EthereumSync.html">EthereumSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/ETH/EthereumTx.js~EthereumTx.html">EthereumTx</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#class-ltc">class/LTC</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/LTC/LitecoinSync.js~LitecoinSync.html">LitecoinSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/LTC/LitecoinTx.js~LitecoinTx.html">LitecoinTx</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#class-xdc">class/XDC</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/XDC/XinfinSync.js~XinfinSync.html">XinfinSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/XDC/XinfinTx.js~XinfinTx.html">XinfinTx</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#helpers">helpers</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/helpers/Request.js~Request.html">Request</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/helpers/handleErrors.js~CustomError.html">CustomError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-requestHandleErrors">requestHandleErrors</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-toFormatDecimal">toFormatDecimal</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-networks">networks</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils">utils</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ab2hexstring">ab2hexstring</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-encodeBinaryByteArray">encodeBinaryByteArray</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sha256">sha256</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sha256ripemd160">sha256ripemd160</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sha3">sha3</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-UVarInt">UVarInt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-VarInt">VarInt</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/class/DOGE/DogecoinSync.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import Request from &apos;@/helpers/Request&apos;
import {getDogeAddress} from &apos;@/helpers/coreHelper&apos;

/**
 * Class DogecoinSync.
 * This class allows you to get information about the balance on a Dogecoin wallet,
 * the list of unspent, a set of addresses that participated in transactions, and a list of transactions
 * @class
 */

export default class DogecoinSync {
  /**
   * Create a DogecoinSync
   * @param {Object} externalNode - External Dogecoin node
   * @param {Object} internalNode - Internal Dogecoin node
   * @param {Object} api - A set of URLs for getting information about Dogecoin addresses
   * @param {Object} headers - Request headers
   */
  constructor (externalNode, internalNode, api, headers) {
    this.externalNode = externalNode
    this.internalNode = internalNode
    this.api = api
    this.balance = 0
    this.latestBlock = 0
    this.unspent = []
    this.addresses = {
      external: [],
      internal: [],
      empty: {},
      all: []
    }
    this.deriveAddress = {
      internal: {},
      external: {}
    }
    this.transactions = {
      all: [],
      unique: []
    }
    this.fee = []
    this.request = new Request(this.api.doge, headers)
    this.type = &apos;p2pkh&apos;
  }

  /**
   * The method that starts the synchronization Dogecoin part of wallet
   * @returns {Promise&lt;boolean&gt;}
   * @constructor
   */

  async Start () {
    this.transactions = {
      all: [],
      unique: []
    }
    this.unspent = []
    await Promise.all([
      await this.getAddresses(),
      await this.getFeesRequest()
    ])
    this.getBalance()
  }

  /**
   * Getting internal and external addresses that were involved in transactions
   * @returns {Promise&lt;boolean&gt;}
   */

  async getAddresses () {
    this.addresses.external = await this.getAddressesByNode(this.externalNode, &apos;external&apos;)
    this.addresses.internal = await this.getAddressesByNode(this.internalNode, &apos;internal&apos;)
    this.addresses.empty = {
      external: this.addresses.external[this.addresses.external.length - 1],
      internal: this.addresses.internal[this.addresses.internal.length - 1]
    }

    this.addresses.all = [...this.addresses.external, ...this.addresses.internal].map((item) =&gt; item.address)
    await this.processTransactions()
    await this.getTxInfoForUnspent()
  }

  /**
   * Auxiliary method that gets the Dogecoin address by node and index
   * @param {Object} node - Dogecoin node
   * @param {string} type - Node type (external or internal)
   * @param {number} from - The index that the derivation starts from
   * @param {number} to - Index to which deprivation occurs
   * @returns {Promise&lt;Array&gt;} Returns array of addresses
   * @private
   */

  async _getArrayOfAddresses (node, type, from, to) {
    let addresses = []

    for (let i = from; i &lt; to; i++) {
      let address = &apos;&apos;

      if (this.deriveAddress[type].hasOwnProperty(i)) {
        address = this.deriveAddress[type][i]
      } else {
        address = getDogeAddress(node, i)
        this.deriveAddress[type][i] = address
      }

      addresses.push(address)
    }

    return addresses
  }

  /**
   * Returns the derivation index for an address
   * @param {string} address
   */

  _getDeriveIndexByAddress (address) {
    let find = this.addresses.external.find(item =&gt; item.address === address)
    let node = &apos;external&apos;

    if (!find) {
      find = this.addresses.internal.find(item =&gt; item.address === address)
      node = &apos;internal&apos;
    }

    return {
      index: find ? find.derive_index : null,
      node
    }
  }

  /**
   * Getting information about addresses and forming an array of addresses.
   * Makes a request for a bundle of addresses and gets a list of transactions
   * @param {Object} node - Dogecoin node
   * @param {string} type - Node type (external or internal)
   * @returns {Promise&lt;Array&gt;} A list of addresses with transactions
   */

  async getAddressesByNode (node, type) {
    const CONTROL_COUNT = 100
    let list = []
    let counter = 0
    let derive_index = 0
    let empty = {
      status: false,
      data: null
    }
    let data = {
      from: 0,
      to: CONTROL_COUNT
    }

    const req = async () =&gt; {
      let addresses = await this._getArrayOfAddresses(
        node,
        type,
        data.from,
        data.to
      )

      try {
        let res = await this.getMultiAddressRequest(addresses)

        if (res.hasOwnProperty(&apos;utxo&apos;)) {
          this.unspent = [...this.unspent, ...res.utxo]
        }

        if (res.hasOwnProperty(&apos;lastblock&apos;)) {
          this.latestBlock = res.lastblock
        }

        if (res.hasOwnProperty(&apos;transactions&apos;) &amp;&amp; res.transactions.length) {
          this.transactions.all = [...this.transactions.all, ...res.transactions]

          for (let i = data.from; i &lt; data.to; i++) {
            if (counter &gt;= CONTROL_COUNT) break
            const index = i &lt; CONTROL_COUNT ? i : i - CONTROL_COUNT
            let address = addresses[index]
            let find = res.transactions.find((itm) =&gt; itm.address === address)
            let item = {
              type,
              derive_index,
              address
            }

            if (find) {
              counter = 0
              list.push(item)
            } else {
              counter++
              if (!empty.status) {
                empty.status = true
                empty.data = item
              }
            }
            derive_index++
          }

          if (counter &lt; CONTROL_COUNT) {
            data.from += CONTROL_COUNT
            data.to += CONTROL_COUNT
            await req()
          } else {
            list.push(empty.data)
          }
        } else {
          if (!empty.status) {
            let item = {
              type,
              derive_index
            }

            if (type === &apos;external&apos;) {
              item.address = getDogeAddress(this.externalNode, derive_index)
            } else {
              item.address = getDogeAddress(this.internalNode, derive_index)
            }
            empty.status = true
            empty.data = item
          }

          list.push(empty.data)
        }
      } catch (e) {
        console.log(&apos;DOGE getAddressesByNode error&apos;, e)
      }
    }

    await req()

    return list
  }

  /**
   * Processing transaction information: setting the type (incoming or outgoing),
   * getting balance, hash, time and block id
   */

  async processTransactions () {
    const hashes = this.transactions.all.map(item =&gt; item.hash)
    const unique_hashes = [...new Set(hashes)]

    for (let hash of unique_hashes) {
      const group = this.transactions.all.filter(item =&gt; item.hash === hash)
      const balance_change = group.reduce((a, b) =&gt; ({balance_change: a.balance_change + b.balance_change})).balance_change

      let tx = {
        hash,
        balance_change,
        block_id: group[0].block_id,
        time: group[0].time,
        action: balance_change &gt; 0 ? &apos;incoming&apos; : &apos;outgoing&apos;
      }

      this.transactions.unique.push(tx)
    }
  }

  /**
   * Gets information necessary to create a Dogecoin transaction
   */

  async getTxInfoForUnspent () {
    if (!this.unspent.length) return
    const unspent = []

    for (let item of this.unspent) {
      if (!item.address) {
        console.log(&apos;Can\&apos;t find the unspent address&apos;)
        continue
      }

      const derivationInfo = this._getDeriveIndexByAddress(item.address)

      if (derivationInfo.index === null) continue

      item.derive_index = derivationInfo.index
      item.node_type = derivationInfo.node
      unspent.push(item)
    }

    this.unspent = unspent
  }

  /**
   * Getting a balance of Dogecoin wallet from a list of unspent
   */

  getBalance () {
    let balance = 0

    this.unspent.forEach((item) =&gt; {
      if (item &amp;&amp; item.hasOwnProperty(&apos;value&apos;)) {
        balance += +item.value
      }
    })

    this.balance = balance
  }

  /**
   * Request for information at multiple addresses
   * @param {Array} addresses - List of addresses to get data from
   * @returns {Promise&lt;Object&gt;} Address information, including a list of transactions
   */

  async getMultiAddressRequest (addresses) {
    if (!addresses) return false

    const OFFSET_STEP = 100
    const TXS_COUNT = 100
    let offset = 0
    let data = {}
    let txs = []

    const req = async () =&gt; {
      let params = {
        method: &apos;all&apos;,
        active: addresses,
        offset: offset,
        limit: TXS_COUNT
      }

      try {
        let res = await this.request.send(params)

        if (res.status === &apos;success&apos;) {
          data = res.data || {}

          if (res.data.hasOwnProperty(&apos;transactions&apos;)) {
            txs = [...txs, ...res.data.transactions]
            if (res.data.transactions.length === TXS_COUNT) {
              offset += OFFSET_STEP
              await req()
            }
          }

          data.transactions = txs
        } else {
          console.log(&apos;DOGE getAddressTransactions&apos;, res.error)
        }
      } catch (err) {
        console.log(&apos;DOGE getAddressTransactions&apos;, err)
        return []
      }
    }

    await req()

    return data
  }

  /**
   * Request to receive a recommended set of dogecoin fees
   * @returns {Promise&lt;Array&gt;} Set of dogecoin fees
   */

  async getFeesRequest () {
    try {
      const res = await fetch(this.api.dogeFee, {headers: this.headers})
      const resJson = await res.json()
      this.fee = resJson.data
    } catch (err) {
      console.log(&apos;DOGE getFeesRequest&apos;, err)
    }
  }

  /**
   * Full information about the dogecoin wallet
   * @returns {Object}
   * @constructor
   */

  get DATA () {
    return {
      addresses: this.addresses,
      transactions: this.transactions,
      unspent: this.unspent,
      balance: this.balance,
      latestBlock: this.latestBlock,
      fee: this.fee
    }
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
