<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">src/class/BNB/transaction.js | lumi-web-core</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Lumi Wallet Core - Web Version"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="lumi-web-core"><meta property="twitter:description" content="Lumi Wallet Core - Web Version"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/lumiwallet/lumi-web-core"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Wrapper.js~Wrapper.html">Wrapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/index.js~Wallet.html">Wallet</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#class">class</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/Core.js~Core.html">Core</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/WalletWrapper.js~WalletWrapper.html">WalletWrapper</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#class-bch">class/BCH</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/BCH/BitcoinCashSync.js~BitcoinCashSync.html">BitcoinCashSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/BCH/BitcoinCashTx.js~BitcoinCashTx.html">BitcoinCashTx</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#class-bnb">class/BNB</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/BNB/transaction.js~BinanceTx.html">BinanceTx</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-decodeAddress">decodeAddress</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-encodeAddress">encodeAddress</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getBnbAddressByPublicKey">getBnbAddressByPublicKey</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-convertObjectToSignBytes">convertObjectToSignBytes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-encodeArrayBinary">encodeArrayBinary</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-encodeBinary">encodeBinary</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-encodeBinaryByteArray">encodeBinaryByteArray</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-encodeBool">encodeBool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-encodeNumber">encodeNumber</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-encodeObjectBinary">encodeObjectBinary</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-encodeString">encodeString</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-marshalBinary">marshalBinary</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getBnbCore">getBnbCore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-convertToBinance">convertToBinance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-convertToJager">convertToJager</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generateSignature">generateSignature</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AminoPrefix">AminoPrefix</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#class-btc">class/BTC</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/BTC/BitcoinSync.js~BitcoinSync.html">BitcoinSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/BTC/BitcoinTx.js~BitcoinTx.html">BitcoinTx</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#class-btcv">class/BTCV</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/BTCV/BitcoinVaultSync.js~BitcoinVaultSync.html">BitcoinVaultSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/BTCV/BitcoinVaultTx.js~BitcoinVaultTx.html">BitcoinVaultTx</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#class-doge">class/DOGE</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/DOGE/DogecoinSync.js~DogecoinSync.html">DogecoinSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/DOGE/DogecoinTx.js~DogecoinTx.html">DogecoinTx</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#class-eth">class/ETH</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/ETH/EthereumSync.js~EthereumSync.html">EthereumSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/ETH/EthereumTx.js~EthereumTx.html">EthereumTx</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#class-ltc">class/LTC</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/LTC/LitecoinSync.js~LitecoinSync.html">LitecoinSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/LTC/LitecoinTx.js~LitecoinTx.html">LitecoinTx</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#class-xdc">class/XDC</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/XDC/XinfinSync.js~XinfinSync.html">XinfinSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/class/XDC/XinfinTx.js~XinfinTx.html">XinfinTx</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#helpers">helpers</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/helpers/Request.js~Request.html">Request</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/helpers/handleErrors.js~CustomError.html">CustomError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-requestHandleErrors">requestHandleErrors</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-toFormatDecimal">toFormatDecimal</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-networks">networks</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils">utils</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ab2hexstring">ab2hexstring</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-encodeBinaryByteArray">encodeBinaryByteArray</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sha256">sha256</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sha256ripemd160">sha256ripemd160</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sha3">sha3</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-UVarInt">UVarInt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-VarInt">VarInt</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/class/BNB/transaction.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import bigDecimal from &apos;js-big-decimal&apos;
import * as crypto from &apos;@/utils/crypto&apos;
import {generateSignature, convertToJager, convertToBinance} from &apos;@/class/BNB/utils&apos;
import {decodeAddress} from &apos;@/class/BNB/address&apos;
import {
  convertObjectToSignBytes,
  marshalBinary,
  AminoPrefix
} from &apos;@/class/BNB/amino&apos;

const DEFAULT_CHAIN_ID = &apos;Binance-Chain-Tigris&apos;
const DEFAULT_SOURCE = 1

/**
 * Class BinanceTx.
 * This class is responsible for calculating the fee list
 * and generating and signing a Binance transaction
 * @class
 */

export default class BinanceTx {
  /**
   * Create a BinanceTx
   * @param {Object} data - Input data for generating a transaction and calculating a fee
   * @param {number} data.chain_id
   * @param {string} data.address - Sender&apos;s address
   * @param {number} data.account_number
   * @param {number} data.sequence
   * @param {number} data.source
   * @param {Array} data.fee - Fee list
   * @param {Array} data.balance - Sender&apos;s balance
   * @param {string} data.privateKey
   * @param {string} data.publicKey
   */

  constructor (data) {
    data = data || {}
    this.chain_id = data.chain_id || DEFAULT_CHAIN_ID
    this.address = data.address
    this.account_number = data.account_number || 0
    this.sequence = data.sequence
    this.source = Number.isInteger(data.source) || DEFAULT_SOURCE
    this.fee = data.fee || []
    this.balance = convertToJager(data.balance)
    this.privateKey = data.privateKey
    this.publicKey = data.publicKey
    this.memo = &apos;&apos;
    this.msg = []
    this.signatures = []
    this.feeList = []
  }

  /**
   * Calculating a fee list
   * @returns {Array} Returns a set of fees
   */

  calcFee () {
    for (let item of this.fee) {
      let fee = {
        id: item.name.toLowerCase(),
        fee: convertToBinance(item.fee),
        value: item.fee
      }

      this.feeList.push(fee)
    }
    return this.feeList
  }

  /**
   * sign transaction with a given private key and msg
   * @param {Object} data - Input data for a transaction
   * @param {string} data.addressTo - Recipient address
   * @param {number} data.amount - The transaction amount
   * @param {number} data.fee - The transaction fee
   * @param {string} data.memo - The transaction memo
   * @return {Transaction}
   **/

  make (data) {
    this.memo = data.memo || &apos;&apos;
    this.msg = this.getSignMsg(data)
    const signBytes = this.getSignBytes(this.msg)
    const privKeyBuf = Buffer.from(this.privateKey, &apos;hex&apos;)
    const signature = generateSignature(
      signBytes.toString(&apos;hex&apos;),
      privKeyBuf
    )
    this.addSignature(this.publicKey, signature)
    return this
  }

  /**
   * Getting signed transaction message
   * @returns {Object}
   */

  getSignMsg (data) {
    const {addressTo, amount, fee} = data
    const feeInJager = convertToJager(fee)
    const amountInJager = convertToJager(amount)
    const fullAmount = bigDecimal.add(feeInJager, amountInJager)
    const change = bigDecimal.subtract(this.balance, fullAmount)

    if (change &lt; 0) {
      throw new Error(&apos;Insufficient balance&apos;)
    }

    const inputs = [
      {
        coins: [
          {
            denom: &apos;BNB&apos;,
            amount: +amountInJager
          }
        ],
        address: this.address
      }
    ]

    const outputs = [
      {
        address: addressTo,
        coins: [
          {
            denom: &apos;BNB&apos;,
            amount: +amountInJager
          }
        ]
      }
    ]

    return {
      inputs,
      outputs
    }
  }

  /**
   * Getting the transaction message
   * @returns {Object}
   */

  getMsg (msg) {
    msg.inputs = msg.inputs.map(item =&gt; {
      return {
        address: decodeAddress(item.address),
        coins: item.coins
      }
    })
    msg.outputs = msg.outputs.map(item =&gt; {
      return {
        address: decodeAddress(item.address),
        coins: item.coins
      }
    })

    msg.aminoPrefix = AminoPrefix.msg
    return msg
  }

  /**
   * Generate the sign bytes for a transaction, given a msg
   * @param {Object} msg - msg object
   * @return {Buffer}
   */

  getSignBytes (msg) {
    const signMsg = {
      account_number: this.account_number.toString(),
      chain_id: this.chain_id,
      data: null,
      memo: this.memo,
      msgs: [msg],
      sequence: this.sequence.toString(),
      source: this.source.toString()
    }
    return convertObjectToSignBytes(signMsg)
  }

  /**
   * Attaches a signature to the transaction
   * @param {string} pubKey
   * @param {Buffer} signature
   */

  addSignature (pubKey, signature) {
    const pubKeyBuf = this._serializePubKey(Buffer.from(this.publicKey, &apos;hex&apos;)) // =&gt; Buffer

    this.signatures = [
      {
        pub_key: pubKeyBuf,
        signature: signature,
        account_number: this.account_number,
        sequence: this.sequence
      }
    ]

    return this
  }

  /**
   * Encode signed transaction to hex which is compatible with amino
   * @returns {string}
   */

  serialize () {
    if (!this.signatures) {
      throw new Error(&apos;need signature&apos;)
    }
    const msg = this.getMsg(this.msg)

    const stdTx = {
      msg: [msg],
      signatures: this.signatures,
      memo: this.memo,
      source: this.source,
      data: &apos;&apos;,
      aminoPrefix: AminoPrefix.tx
    }

    const bytes = marshalBinary(stdTx)
    this.rawTx = bytes.toString(&apos;hex&apos;)
    return this.rawTx
  }

  /**
   * Getting the transaction hash
   * @returns {string}
   */

  getHash () {
    if (this.rawTx) {
      return crypto.sha256(this.rawTx).toUpperCase()
    }

    return &apos;&apos;
  }

  /**
   * Serializes a public key in a 33-byte compressed format.
   * @param {Buffer} unencodedPubKey
   * @return {Buffer}
   */

  _serializePubKey (unencodedPubKey) {
    let pubBz = crypto.encodeBinaryByteArray(unencodedPubKey)
    pubBz = Buffer.concat([Buffer.from(AminoPrefix.PubKeySecp256k1, &apos;hex&apos;), pubBz])

    return pubBz
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
